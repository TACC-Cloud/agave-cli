#!/usr/bin/env python
"""
    auth-session-init [OPTION]

Creates a new API client application and generates a set of API keys for the user.

 Options:
    -c, --cachedir     Directory to save confiurations in.
    -t, --tenant       Tenant id for session.
    -u, --username     Session username.
    -N, --client_name  Name of client.
    -D, --description  Description of the client.
"""
from __future__ import print_function
import argparse
import os
import socket
import sys
from agavepy.agave import Agave

parser = argparse.ArgumentParser(description="Create a new Agave oauth client")

parser.add_argument(
    "-c",
    "--cachedir",
    default=os.path.expanduser("~/.agave"),
    help="Directory to save confiurations in.")

parser.add_argument(
    "--tenants",
    default="https://agaveapi.co/tenants",
    help="URL with tenants listings.")

parser.add_argument("-t", "--tenant", help="Tenant id for session.")

parser.add_argument("-u", "--username", help="Session username.")

parser.add_argument("-N", "--name", dest="client_name", help="Name of client.")

parser.add_argument("-D", "--description", help="Description of client.")

if __name__ == "__main__":
    args = parser.parse_args()

    agave = Agave()
    cache_dir = args.cachedir
    tenant_id = args.tenant
    username = args.username
    client_name = args.client_name
    client_description = args.description

    config_file = "{}/config.json".format(cache_dir)
    # Check if there is a session already saved.
    if os.path.exists(config_file):
        agave.load_configs(
            cache_dir=cache_dir,
            tenant_id=tenant_id,
            username=username,
            client_name=client_name)

    # Set tenant info.
    if agave.tenant_id is None:
        if tenant_id is not None:
            agave.tenant_id = tenant_id
        try:
            agave.init(args.tenants)
        except KeyError:
            print("Select a valid tenant id...")
            agave.list_tenants()
            sys.exit(1)

    # Create client if necessary.
    if agave.client_name is None or agave.client_name != client_name:
        if client_name is None:
            client_name = socket.gethostname()
        else:
            print("Client '{}' is not saved in {}, so we will create it...".
                  format(client_name, cache_dir))
        if client_description is None:
            client_description = "Autogenerated client"

        print("Creating a client...")
        agave.clients_create(client_name, client_description)
        print("Created client {} - {}".format(client_name, client_description))

        # Zero out token and refresh token.
        agave.token = None
        agave.refresh_token = None

    # Get access token or refresh if necessary.
    if isinstance(agave.token, str) and isinstance(agave.refresh_token, str):
        if agave.token != "" and agave.refresh_token != "":
            agave.refresh_tokens()
    else:
        print("Getting oauth bearer tokens...")
        agave.get_access_token()

    # Save session.
    agave.save_configs(cache_dir)
